<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Combining capabilities - Pony Tutorial</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Pony Tutorial">
    <meta property="og:image" content="None/../../">
    <meta name="apple-mobile-web-app-title" content="Pony Tutorial">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-20d5debb47.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/highlight.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Capabilities <i class="icon icon-link"></i>
              
            
          </span>
        
        Combining capabilities
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="/" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Pony Tutorial </strong>
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
      <div class="toc">
        <ul>
          
            
  <li>
    <span class="section">Getting started</span>
    <ul>
      
        
  <li>
    <a class="" title="Welcome!" href="../..">
      Welcome!
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="What you need to start" href="../../getting-started/what-you-need-to-start/">
      What you need to start
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Installation" href="../../getting-started/installation/">
      Installation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Helloworld" href="../../getting-started/helloworld/">
      Helloworld
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="How it works" href="../../getting-started/how-it-works/">
      How it works
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Whitespace" href="../../getting-started/whitespace/">
      Whitespace
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Types</span>
    <ul>
      
        
  <li>
    <a class="" title="Static vs dynamic" href="../../types/static-vs-dynamic/">
      Static vs dynamic
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Classes" href="../../types/classes/">
      Classes
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Primitives" href="../../types/primitives/">
      Primitives
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Actors" href="../../types/actors/">
      Actors
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Traits and interfaces" href="../../types/traits-and-interfaces/">
      Traits and interfaces
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type aliases" href="../../types/type-aliases/">
      Type aliases
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type expressions" href="../../types/type-expressions/">
      Type expressions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Delegates" href="../../types/delegates/">
      Delegates
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Expressions</span>
    <ul>
      
        
  <li>
    <a class="" title="Variables" href="../../expressions/variables/">
      Variables
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Infix ops" href="../../expressions/infix-ops/">
      Infix ops
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Control structures" href="../../expressions/control-structures/">
      Control structures
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Methods" href="../../expressions/methods/">
      Methods
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Exceptions" href="../../expressions/exceptions/">
      Exceptions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Sugar" href="../../expressions/sugar/">
      Sugar
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Object literals" href="../../expressions/object-literals/">
      Object literals
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Partial application" href="../../expressions/partial-application/">
      Partial application
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Capabilities</span>
    <ul>
      
        
  <li>
    <a class="" title="Object capabilities" href="../object-capabilities/">
      Object capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Reference capabilities" href="../reference-capabilities/">
      Reference capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Guarantees" href="../guarantees/">
      Guarantees
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Aliasing" href="../aliasing/">
      Aliasing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consume and destructive read" href="../consume-and-destructive-read/">
      Consume and destructive read
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Recovering capabilities" href="../recovering-capabilities/">
      Recovering capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Combining capabilities" href="./">
      Combining capabilities
    </a>
    
      
        
      
      
    
  </li>

      
        
  <li>
    <a class="" title="Passing and sharing" href="../passing-and-sharing/">
      Passing and sharing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Capability subtyping" href="../capability-subtyping/">
      Capability subtyping
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Arrow types" href="../arrow-types/">
      Arrow types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Trust boundary" href="../trust-boundary/">
      Trust boundary
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Generics</span>
    <ul>
      
        
  <li>
    <a class="" title="Polymorphic types" href="../../generics/polymorphic-types/">
      Polymorphic types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Polymorphic methods" href="../../generics/polymorphic-methods/">
      Polymorphic methods
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Code sharing" href="../../composition-inheritance/code-sharing/">
      Code sharing
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Pattern Matching</span>
    <ul>
      
        
  <li>
    <a class="" title="Match" href="../../pattern-matching/match/">
      Match
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="As" href="../../pattern-matching/as/">
      As
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Packages</span>
    <ul>
      
        
  <li>
    <a class="" title="Package system" href="../../packages/package-system/">
      Package system
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use statement" href="../../packages/use-statement/">
      Use statement
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Builtin" href="../../packages/builtin/">
      Builtin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use conditions" href="../../packages/platform/">
      Use conditions
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Compiler args" href="../../compiler-clargs/clargs/">
      Compiler args
    </a>
    
  </li>

          
            
  <li>
    <span class="section">C FFI</span>
    <ul>
      
        
  <li>
    <a class="" title="Calling C" href="../../c-ffi/calling-c/">
      Calling C
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Linking to C Libraries" href="../../c-ffi/linking-c/">
      Linking to C Libraries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="C abi" href="../../c-ffi/c-abi/">
      C abi
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">The Runtime</span>
    <ul>
      
        
  <li>
    <a class="" title="Otp" href="../../runtime/otp/">
      Otp
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Memory allocation" href="../../runtime/memory-allocation/">
      Memory allocation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Garbage collection" href="../../runtime/garbage-collection/">
      Garbage collection
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Examples" href="../../examples/examples/">
      Examples
    </a>
    
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <p>When a field of an object is read, its reference capability depends both on the reference capability of the field and the reference capability of the <strong>origin</strong>, that is, the object the field is being read from.</p>
<p>This is because all the guarantees that the <strong>origin</strong> reference capability makes have to be maintained for its fields as well.</p>
<h1 id="viewpoint-adaptation">Viewpoint adaptation</h1>
<p>The process of combining origin and field capabilties is called <strong>viewpoint adaptation</strong>. That is, the <strong>origin</strong> has a <strong>viewpoint</strong>, and can "see" its fields only from that <strong>viewpoint</strong>.</p>
<p>Let's start with a table. This shows how <strong>fields</strong> of each capability "look" to <strong>origins</strong> of each capability.</p>
<hr />
<table>
<thead>
<tr>
<th>&#x25B7;</th>
<th>iso field</th>
<th>trn field</th>
<th>ref field</th>
<th>val field</th>
<th>box field</th>
<th>tag field</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>iso origin</strong></td>
<td>iso</td>
<td>tag</td>
<td>tag</td>
<td>val</td>
<td>tag</td>
<td>tag</td>
</tr>
<tr>
<td><strong>trn origin</strong></td>
<td>iso</td>
<td>trn</td>
<td>box</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>ref origin</strong></td>
<td>iso</td>
<td>trn</td>
<td>ref</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>val origin</strong></td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>val</td>
<td>tag</td>
</tr>
<tr>
<td><strong>box origin</strong></td>
<td>tag</td>
<td>box</td>
<td>box</td>
<td>val</td>
<td>box</td>
<td>tag</td>
</tr>
<tr>
<td><strong>tag origin</strong></td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
<td>n/a</td>
</tr>
</tbody>
</table>
<hr />
<p>For example, if you have a <code>trn</code> origin and you read a <code>ref</code> field, you get a <code>box</code> result:</p>
<pre><code class="pony">class Foo
  var x: String ref

class Bar
  fun f() =&gt;
    var y: Foo trn = getTrnFoo()
    var z: String box = y.x
</code></pre>

<h1 id="explaining-why">Explaining why</h1>
<p>That table will seem totally natural to you, eventually. But probably not yet. To help it seem natural, let's walk through each cell in the table and explain why it is the way it is.</p>
<h2 id="reading-from-an-iso-variable">Reading from an <code>iso</code> variable</h2>
<p>Anything read through an <code>iso</code> origin has to maintain the isolation guarantee that the origin has. The key thing to remember is that the <code>iso</code> can be sent to another actor and it can also become any other reference capability. So when we read a field, we need to get a result that won't ever break the isolation guarantees that the origin makes, that is, <em>read and write uniqueness</em>.</p>
<p>An <code>iso</code> field makes the same guarantees as an <code>iso</code> origin, so that's fine to read. A <code>val</code> field is <em>globally immutable</em>, which means it's always ok to read it, no matter what the origin is (well, other than <code>tag</code>).</p>
<p>Everything else, though, can break our isolation guarantees. That's why other reference capabilities are seen as <code>tag</code>: it's the only type that is neither readable nor writeable.</p>
<h2 id="reading-from-a-trn-variable">Reading from a <code>trn</code> variable</h2>
<p>This is like <code>iso</code>, but with a weaker guarantee (<em>write uniqueness</em> as opposed to <em>read and write uniqueness</em>). That makes a big difference, since now we can return something readable when we enforce our guarantees.</p>
<p>An <code>iso</code> field makes stronger guarantees than a <code>trn</code> origin, and a <code>trn</code> field makes the same guarantees, so they're fine to read. A <code>val</code> field is <em>globally immutable</em>, so that's fine too. A <code>box</code> field is readable, and we only guarantee <em>write uniqueness</em>, so that's fine too.</p>
<p>A <code>ref</code> field, though, would allow writing. So instead we return a <code>box</code>.</p>
<h2 id="reading-from-a-ref-variable">Reading from a <code>ref</code> variable</h2>
<p>A <code>ref</code> origin doesn't modify its fields at all. This is because a <code>ref</code> origin doesn't make any guarantees that are incompatible with its fields.</p>
<h2 id="reading-from-a-val-variable">Reading from a <code>val</code> variable</h2>
<p>A <code>val</code> origin is deeply and globally immutable, so all of its fields are also <code>val</code>. The only exception is a <code>tag</code> field. Since we can't read from it, we also can't guarantee that nobody can write to it, so it stays <code>tag</code>.</p>
<h2 id="reading-from-a-box-variable">Reading from a <code>box</code> variable</h2>
<p>A <code>box</code> variable is locally immutable. This means it's possible that it may be mutated through some other variable (a <code>trn</code> or a <code>ref</code>), but it's also possible that our <code>box</code> variable is an alias of some <code>val</code> variable.</p>
<p>When we read a field, we need to return a reference capability that is compatible with the field, but is also locally immutable.</p>
<p>An <code>iso</code> field is returned as a <code>tag</code> because no locally immutable reference capability can maintain its isolation guarantees. A <code>val</code> field is returned as a <code>val</code> because global immutability is a stronger guarantee than local immutability. A <code>box</code> field makes the same local immutability guarantee as its origin, so that's also fine.</p>
<p>For <code>trn</code> and <code>ref</code> we need to return a locally immutable reference capability that doesn't violate any guarantees the field makes. In both cases, we can return <code>box</code>.</p>
<h2 id="reading-from-a-tag-variable">Reading from a <code>tag</code> variable</h2>
<p>This one is easy: <code>tag</code> variables are opaque! They can't be read from.</p>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../recovering-capabilities/" title="Recovering capabilities">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Recovering capabilities
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../passing-and-sharing/" title="Passing and sharing">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Passing and sharing
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = '';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>