<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Reference capabilities - Pony Tutorial</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Pony Tutorial">
    <meta property="og:image" content="None/../../">
    <meta name="apple-mobile-web-app-title" content="Pony Tutorial">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-20d5debb47.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/highlight.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Capabilities <i class="icon icon-link"></i>
              
            
          </span>
        
        Reference capabilities
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="/" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Pony Tutorial </strong>
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
      <div class="toc">
        <ul>
          
            
  <li>
    <span class="section">Getting started</span>
    <ul>
      
        
  <li>
    <a class="" title="Welcome!" href="../..">
      Welcome!
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="What you need to start" href="../../getting-started/what-you-need-to-start/">
      What you need to start
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Installation" href="../../getting-started/installation/">
      Installation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Helloworld" href="../../getting-started/helloworld/">
      Helloworld
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="How it works" href="../../getting-started/how-it-works/">
      How it works
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Whitespace" href="../../getting-started/whitespace/">
      Whitespace
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Types</span>
    <ul>
      
        
  <li>
    <a class="" title="Static vs dynamic" href="../../types/static-vs-dynamic/">
      Static vs dynamic
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Classes" href="../../types/classes/">
      Classes
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Primitives" href="../../types/primitives/">
      Primitives
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Actors" href="../../types/actors/">
      Actors
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Traits and interfaces" href="../../types/traits-and-interfaces/">
      Traits and interfaces
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type aliases" href="../../types/type-aliases/">
      Type aliases
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type expressions" href="../../types/type-expressions/">
      Type expressions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Delegates" href="../../types/delegates/">
      Delegates
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Expressions</span>
    <ul>
      
        
  <li>
    <a class="" title="Variables" href="../../expressions/variables/">
      Variables
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Infix ops" href="../../expressions/infix-ops/">
      Infix ops
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Control structures" href="../../expressions/control-structures/">
      Control structures
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Methods" href="../../expressions/methods/">
      Methods
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Exceptions" href="../../expressions/exceptions/">
      Exceptions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Sugar" href="../../expressions/sugar/">
      Sugar
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Object literals" href="../../expressions/object-literals/">
      Object literals
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Partial application" href="../../expressions/partial-application/">
      Partial application
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Capabilities</span>
    <ul>
      
        
  <li>
    <a class="" title="Object capabilities" href="../object-capabilities/">
      Object capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Reference capabilities" href="./">
      Reference capabilities
    </a>
    
      
        
      
      
    
  </li>

      
        
  <li>
    <a class="" title="Guarantees" href="../guarantees/">
      Guarantees
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Aliasing" href="../aliasing/">
      Aliasing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consume and destructive read" href="../consume-and-destructive-read/">
      Consume and destructive read
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Recovering capabilities" href="../recovering-capabilities/">
      Recovering capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Combining capabilities" href="../combining-capabilities/">
      Combining capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Passing and sharing" href="../passing-and-sharing/">
      Passing and sharing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Capability subtyping" href="../capability-subtyping/">
      Capability subtyping
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Arrow types" href="../arrow-types/">
      Arrow types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Trust boundary" href="../trust-boundary/">
      Trust boundary
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Generics</span>
    <ul>
      
        
  <li>
    <a class="" title="Polymorphic types" href="../../generics/polymorphic-types/">
      Polymorphic types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Polymorphic methods" href="../../generics/polymorphic-methods/">
      Polymorphic methods
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Code sharing" href="../../composition-inheritance/code-sharing/">
      Code sharing
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Pattern Matching</span>
    <ul>
      
        
  <li>
    <a class="" title="Match" href="../../pattern-matching/match/">
      Match
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="As" href="../../pattern-matching/as/">
      As
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Packages</span>
    <ul>
      
        
  <li>
    <a class="" title="Package system" href="../../packages/package-system/">
      Package system
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use statement" href="../../packages/use-statement/">
      Use statement
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Builtin" href="../../packages/builtin/">
      Builtin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use conditions" href="../../packages/platform/">
      Use conditions
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Compiler args" href="../../compiler-clargs/clargs/">
      Compiler args
    </a>
    
  </li>

          
            
  <li>
    <span class="section">C FFI</span>
    <ul>
      
        
  <li>
    <a class="" title="Calling C" href="../../c-ffi/calling-c/">
      Calling C
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Linking to C Libraries" href="../../c-ffi/linking-c/">
      Linking to C Libraries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="C abi" href="../../c-ffi/c-abi/">
      C abi
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">The Runtime</span>
    <ul>
      
        
  <li>
    <a class="" title="Otp" href="../../runtime/otp/">
      Otp
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Memory allocation" href="../../runtime/memory-allocation/">
      Memory allocation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Garbage collection" href="../../runtime/garbage-collection/">
      Garbage collection
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Examples" href="../../examples/examples/">
      Examples
    </a>
    
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <p>So if the object <em>is</em> the capability, what controls what we can do with the object? How do we express our <em>access rights</em> on that object?</p>
<p>In Pony, we do it with <em>reference capabilities</em>.</p>
<h1 id="rights-are-part-of-a-capability">Rights are part of a capability</h1>
<p>If you open a file in UNIX, and get a file descriptor back, that file descriptor is token that designates an object - but it isn't a capability. To be a capability, we need to open that file with some permission - some access right. For example:</p>
<pre><code class="C">int fd = open(&quot;/etc/passwd&quot;, O_RDWR);
</code></pre>

<p>Now we have a token, and a set of rights.</p>
<p>In Pony, every reference has both a type and a reference capability. In fact, the reference capability is <em>part</em> of its type. These allow you to specify which of your objects can be shared with other actors and allow the compiler to check that what you're doing is concurrency safe.</p>
<h1 id="basic-concepts">Basic concepts</h1>
<p>There are a few simple concepts you need to understand before reference capabilities will make any sense. We've talked about some of these already, and some may already be obvious to you, but it's worth recapping here.</p>
<p><strong>Shared mutable data is hard</strong></p>
<p>The problem with concurrency is shared mutable data. If two different threads have access to the same piece of data then they might try to update it at the same time. At best this can lead to the two threads having different versions of the data. At worst the updates can interact badly resulting in the data being overwritten with garbage. The standard way to avoid these problems is to use locks to prevent data updates from happening at the same time. This causes big performance hits and is very difficult to get right, so it causes lots of bugs.</p>
<p><strong>Immutable data can be safely shared</strong></p>
<p>Any data that is immutable (i.e. it cannot be changed) is safe to use concurrently. Since it is immutable it is never updated and it's the updates that cause concurrency problems.</p>
<p><strong>Isolated data is safe</strong></p>
<p>If a block of data has only one reference to it then we call it <strong>isolated</strong>. Since there is only one reference to it, isolated data cannot be <strong>shared</strong> by multiple threads, so there are no concurrency problems. Isolated data can be passed between multiple threads. As long as only one of them has a reference to it at a time then the data is still safe from concurrency problems.</p>
<p><strong>Isolated data may be complex</strong></p>
<p>An isolated piece of data may be a single byte. But it can also be a large data structure with multiple references between the various objects in that structure. What matters for the data to be isolated is that there is only a single reference to that structure as a whole. We talk about the <strong>isolation boundary</strong> of a data structure. For the structure to be isolated:</p>
<ol>
<li>There must only be a single reference outside the boundary that points to an object inside.</li>
<li>There can be any number of references inside the boundary, but none of them must point to an object outside.</li>
</ol>
<p><strong>Every actor is single threaded</strong></p>
<p>The code within a single actor is never run concurrently. This means that, within a single actor, data updates cannot cause problems. It's only when we want to share data between actors that we have problems.</p>
<p><strong>OK, safely sharing data concurrently is tricky. How do reference capabilities help?</strong></p>
<p>By sharing only immutable data and exchanging only isolated data we can have safe concurrent programs without locks. The problem is that it's very difficult to do that correctly. If you accidentally hang on to a reference to some isolated data you've handed over or change something you've shared as immutable then everything goes wrong. What you need is for the compiler to force you to live up to your promises. Pony reference capabilities allow the compiler to do just that.</p>
<h1 id="type-qualifiers">Type qualifiers</h1>
<p>If you've used C/C++, you may be familiar with <code>const</code>, which is a <em>type qualifier</em> that tells the compiler not to allow the programmer to <em>mutate</em> something.</p>
<p>A reference capability is a form of <em>type qualifier</em> and provides a lot more guarantees than <code>const</code> does!</p>
<p>In Pony, every use of a type has a reference capability. These capabilities apply to variables, rather than to the type as a whole. In other words, when you define a <code>class Wombat</code>, you don't pick a reference capability for it. Instead, <code>Wombat</code> variables each have their own reference capability.</p>
<p>As an example, in some languages you have to define a type that represents a mutable <code>String</code> and another type that represents an immutable <code>String</code>. For example, in Java there is a <code>String</code> and a <code>StringBuilder</code>. In Pony, you can define a single <code>class String</code> and have some variables that are <code>String ref</code> (which are mutable) and other variables that are <code>String val</code> (which are immutable).</p>
<h1 id="the-list-of-reference-capabilities">The list of reference capabilities</h1>
<p>There are six reference capabilities in Pony and they all have strict definitions and rules on how they can be used. We'll get to all of that later, but for now here are their names and what you use them for:</p>
<p><strong>Isolated</strong>, written <code>iso</code>. This is for references to isolated data structures. If you have an <code>iso</code> variable then you know that there are no other variables that can access that data. So you can change it however you like and give it to another actor.</p>
<p><strong>Value</strong>, written <code>val</code>. This is for references to immutable data structures. If you have a <code>val</code> variable then you know that no-one can change the data. So you can read it and share it with other actors.</p>
<p><strong>Reference</strong>, written <code>ref</code>. This is for references to mutable data structures that are not isolated, in other words "normal" data. If you have a <code>ref</code> variable then you can read and write the data however you like and you can have multiple variables that can access the same data. But you can't share it with other actors.</p>
<p><strong>Box</strong>. This is for references to data that is read-only to you. That data might be immutable and shared with other actors or there may be other variables using it in your actor that can change the data. Either way the <code>box</code> variable can be used to safely read the data. This may sound a little pointless, but it allows you to write code that can work for both <code>val</code> and <code>ref</code> variables, as long as it doesn't write to the object.</p>
<p><strong>Transition</strong>, written <code>trn</code>. This is used for data structures that you want to write to and give out read-only (<code>box</code>) variables to. You can also convert the <code>trn</code> variable to a <code>val</code> variable later if you wish, which stops anyone from changing the data and allows it be shared with other actors.</p>
<p><strong>Tag</strong>. This is for references used only for identification. You cannot read or write data using a <code>tag</code> variable. But you can store and compare <code>tag</code>s to check object identity and share <code>tag</code> variables with other actors.</p>
<p>Note that if you have a variable referring to an actor then you can send messages to that actor regardless of what reference capability that variable has.</p>
<h1 id="how-to-write-a-reference-capability">How to write a reference capability</h1>
<p>A reference capability comes at the end of a type. So, for example:</p>
<pre><code class="pony">String iso // An isolated string
String trn // A transition string
String ref // A string reference
String val // A string value
String box // A string box
String tag // A string tag
</code></pre>

<p><strong>What does it mean when a type doesn't specify a reference capability?</strong> It means you are using the <em>default</em> reference capability for that type, which is defined along with the type. Here's an example from the standard library:</p>
<pre><code class="pony">class String val
</code></pre>

<p>When we use a <code>String</code> we usually mean a string value, so we make <code>val</code> the default reference capability for <code>String</code>.</p>
<p><strong>So do I have to specify a reference capability when I define a type?</strong> Only if you want to. There are sensible defaults that most types will use. These are <code>ref</code> for classes, <code>val</code> for primitives (i.e. immutable references) and <code>tag</code> for actors.
So the default for any mutable reference capability is <code>iso</code> and the default for any immutable reference capability is <code>val</code>.</p>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../object-capabilities/" title="Object capabilities">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Object capabilities
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../guarantees/" title="Guarantees">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Guarantees
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = '';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>