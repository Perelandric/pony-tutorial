<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Calling C - Pony Tutorial</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Pony Tutorial">
    <meta property="og:image" content="None/../../">
    <meta name="apple-mobile-web-app-title" content="Pony Tutorial">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-20d5debb47.css">
    
    
      
      
      
      <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
      <link rel="stylesheet" href="../../css/highlight.css">
    
    <script src="../../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                C FFI <i class="icon icon-link"></i>
              
            
          </span>
        
        Calling C
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="/" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>Pony Tutorial </strong>
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
      <div class="toc">
        <ul>
          
            
  <li>
    <span class="section">Getting started</span>
    <ul>
      
        
  <li>
    <a class="" title="Welcome!" href="../..">
      Welcome!
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="What you need to start" href="../../getting-started/what-you-need-to-start/">
      What you need to start
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Installation" href="../../getting-started/installation/">
      Installation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Helloworld" href="../../getting-started/helloworld/">
      Helloworld
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="How it works" href="../../getting-started/how-it-works/">
      How it works
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Whitespace" href="../../getting-started/whitespace/">
      Whitespace
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Types</span>
    <ul>
      
        
  <li>
    <a class="" title="Static vs dynamic" href="../../types/static-vs-dynamic/">
      Static vs dynamic
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Classes" href="../../types/classes/">
      Classes
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Primitives" href="../../types/primitives/">
      Primitives
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Actors" href="../../types/actors/">
      Actors
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Traits and interfaces" href="../../types/traits-and-interfaces/">
      Traits and interfaces
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type aliases" href="../../types/type-aliases/">
      Type aliases
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Type expressions" href="../../types/type-expressions/">
      Type expressions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Delegates" href="../../types/delegates/">
      Delegates
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Expressions</span>
    <ul>
      
        
  <li>
    <a class="" title="Variables" href="../../expressions/variables/">
      Variables
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Infix ops" href="../../expressions/infix-ops/">
      Infix ops
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Control structures" href="../../expressions/control-structures/">
      Control structures
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Methods" href="../../expressions/methods/">
      Methods
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Exceptions" href="../../expressions/exceptions/">
      Exceptions
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Sugar" href="../../expressions/sugar/">
      Sugar
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Object literals" href="../../expressions/object-literals/">
      Object literals
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Partial application" href="../../expressions/partial-application/">
      Partial application
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Capabilities</span>
    <ul>
      
        
  <li>
    <a class="" title="Object capabilities" href="../../capabilities/object-capabilities/">
      Object capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Reference capabilities" href="../../capabilities/reference-capabilities/">
      Reference capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Guarantees" href="../../capabilities/guarantees/">
      Guarantees
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Aliasing" href="../../capabilities/aliasing/">
      Aliasing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Consume and destructive read" href="../../capabilities/consume-and-destructive-read/">
      Consume and destructive read
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Recovering capabilities" href="../../capabilities/recovering-capabilities/">
      Recovering capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Combining capabilities" href="../../capabilities/combining-capabilities/">
      Combining capabilities
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Passing and sharing" href="../../capabilities/passing-and-sharing/">
      Passing and sharing
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Capability subtyping" href="../../capabilities/capability-subtyping/">
      Capability subtyping
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Arrow types" href="../../capabilities/arrow-types/">
      Arrow types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Trust boundary" href="../../capabilities/trust-boundary/">
      Trust boundary
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Generics</span>
    <ul>
      
        
  <li>
    <a class="" title="Polymorphic types" href="../../generics/polymorphic-types/">
      Polymorphic types
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Polymorphic methods" href="../../generics/polymorphic-methods/">
      Polymorphic methods
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Code sharing" href="../../composition-inheritance/code-sharing/">
      Code sharing
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Pattern Matching</span>
    <ul>
      
        
  <li>
    <a class="" title="Match" href="../../pattern-matching/match/">
      Match
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="As" href="../../pattern-matching/as/">
      As
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Packages</span>
    <ul>
      
        
  <li>
    <a class="" title="Package system" href="../../packages/package-system/">
      Package system
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use statement" href="../../packages/use-statement/">
      Use statement
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Builtin" href="../../packages/builtin/">
      Builtin
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Use conditions" href="../../packages/platform/">
      Use conditions
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Compiler args" href="../../compiler-clargs/clargs/">
      Compiler args
    </a>
    
  </li>

          
            
  <li>
    <span class="section">C FFI</span>
    <ul>
      
        
  <li>
    <a class="current" title="Calling C" href="./">
      Calling C
    </a>
    
      
        
      
      
    
  </li>

      
        
  <li>
    <a class="" title="Linking to C Libraries" href="../linking-c/">
      Linking to C Libraries
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="C abi" href="../c-abi/">
      C abi
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">The Runtime</span>
    <ul>
      
        
  <li>
    <a class="" title="Otp" href="../../runtime/otp/">
      Otp
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Memory allocation" href="../../runtime/memory-allocation/">
      Memory allocation
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Garbage collection" href="../../runtime/garbage-collection/">
      Garbage collection
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <a class="" title="Examples" href="../../examples/examples/">
      Examples
    </a>
    
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <p>Pony supports integration with other native languages through the
Foreign Function Interface (FFI). The FFI library provides a stable
and portable API and high level programming interface allowing Pony
to integrate with native libraries easily.</p>
<p>Note that calling C (or other low level languages) is inherently dangerous. C code fundamentally has access to all memory in the process and can change any of it, either deliberately or due to bugs. This is one of the language's most useful, but also most dangerous, features. Calling well written, bug free, C code will have no ill effects on your program. However, calling buggy or malicious C code or calling C incorrectly can cause your Pony program to go wrong, including corrupting data and crashing. Consequently all of Pony guarantees regarding not crashing, memory safety and concurrent correctness can be voided by calling FFI functions.</p>
<h1 id="calling-ffi-functions">Calling FFI functions</h1>
<p>FFI is built into Pony and native libraries may be directly referenced
in Pony code. There is no need to code or configure bindings, wrappers or interfaces.</p>
<p>Here's an example of an FFI call in Pony from the standard library. It looks like a normal method call, with just a few differences:</p>
<pre><code class="pony">@fwrite[U64](data.cstring(), U64(1), data.size(), _handle)
</code></pre>

<p>The main difference is the @ symbol before the function name. This is what tells us it's an FFI call. Any time you see an @ in Pony there's an FFI going on.</p>
<p>The other key difference is that the return type of the function is specified after the function name, in square brackets. This is because the compiler needs to know what type the value returned is (if any), but has no way to determine that, so it needs you to explicitly tell it.</p>
<p>There are a few unusual things going on with the arguments to this FFI call as well. For the second argument, for which we're passing the value 1, we've had to specify that this is a U64. Again this is because the compiler needs to know what size argument to use, but has no way to determine this.</p>
<h1 id="safely-does-it">Safely does it</h1>
<p><strong>It is VERY important that when calling FFI functions you MUST get the parameter and return types right</strong>. The compiler has no way to know what the native code expects and will just believe whatever you do. Errors here can cause invalid data to be passed to the FFI function or returned to Pony, which can lead to program crashes.</p>
<p>To help avoid bugs here Pony allows you to specify the type signatures of FFI functions in advance. Whilst you must still get the types correct the arguments you provide at each FFI call site are checked against the declared signature. This means that you must get a type wrong, in the same way, in at least 2 places for a bug to exist. This won't help if the argument types the native code expects are different to what you think they are, but it will protect you against trivial mistakes and simple typos.</p>
<p>FFI signatures are declared using the <code>use</code> command. Here's an example from the standard library:</p>
<pre><code class="pony">use @SSL_CTX_ctrl[I32](ctx: Pointer[_SSLContext] tag, op: I32, arg: I32,
  parg: Pointer[U8] tag) if windows

use @SSL_CTX_ctrl[I64](ctx: Pointer[_SSLContext] tag, op: I32, arg: I64,
  parg: Pointer[U8] tag) if not windows

class SSLContext val
  new create() =&gt;
    // set SSL_OP_NO_SSLv2
    @SSL_CTX_ctrl(_ctx, 32, 0x01000000, Pointer[U8])
</code></pre>

<p>The @ symbol tells us that the use command is an FFI signature declaration. The types specified here are considered authoritative and any FFI calls that differ are considered to be an error.</p>
<p>Note that we no longer need to specify the return type at the call site, since the signature declaration has already told us what it is. However, it is perfectly acceptable to specify it again if you want to.</p>
<p>The use @ command can take a condition just like other use commands. This is useful in this case, where the Windows version of SSL_CTX_ctrl has a slightly different signature to other platforms.</p>
<h1 id="c-types">C types</h1>
<p>Many C functions require types that don't have an exact equivalent in Pony. A variety of features are provided for these.</p>
<p>For FFI functions that have no return value (ie they return <code>void</code> in C) the return value specified should be <code>[None]</code>.</p>
<p>In Pony String is an object with a header and fields, but in C a <code>char*</code> is simply a pointer to character data. The <code>.cstring()</code> function on String provides us with a valid pointer to hand to C. Our fwrite example above makes use of this for the first argument.</p>
<p>Pony classes corresponds directly to pointers to the class in C.</p>
<p>For C pointers to simple types, such as U64, the Pony <code>Pointer[]</code> polymorphic type should be used, with a <code>tag</code> reference capability. <code>Pointer[U8] tag</code> should be used for void*. This can be seen in our <code>SSL_CTX_ctrl</code> example above.</p>
<p>To pass pointers to values to C the <code>addressof</code> operator can be used (previously <code>&amp;</code>), just like taking an address in C. This is done in the standard library to pass the address of a <code>U64</code> to an FFI function that takes a <code>uint64_t*</code> as an out parameter:</p>
<pre><code class="pony">var len = U64(0)
@pcre2_substring_length_bynumber_8[I32](_match, i.u32(), addressof len)
</code></pre>

<h2 id="to-read-c-structs-from-ffi">To read c structs from FFI</h2>
<p>If you have a c struct like this</p>
<pre><code class="c">typedef struct {
  uint8_t code;
  float x;
  float y;
} EGLEvent;

EGLEvent getEvent() {
    EGLEvent e = {1, ev.xconfigure.width, ev.xconfigure.height};
    return e;
}
</code></pre>

<p>the you can destructure it and get the values using a tuple</p>
<pre><code class="pony">type EGLEvent is (U8, F32, F32)
(var code, var x, var y) = @getEvent[EGLEvent]()
</code></pre>

<h2 id="to-pass-c-structs-to-ffi">To pass c structs to FFI</h2>
<p>If you have a c struct like this</p>
<pre><code class="c">typedef struct {
  uint8_t code;
  float x;
  float y;
} EGLEvent;

void setEvent(EGLEvent e) {
    printf(&quot;%d&quot;, e.code);
}
</code></pre>

<p>then you call it like this</p>
<pre><code class="pony">type EGLEvent is (U8, F32, F32)
let e: EGLEvent = (4, 0, 0)
@setEvent[None](e)
</code></pre>

<h2 id="get-and-pass-pointers-to-ffi">Get and Pass Pointers to FFI</h2>
<p>To pass and receive pointers to c structs you need to declare pointer to primitives</p>
<pre><code class="pony">primitive _XDisplayHandle
primitive _EGLDisplayHandle

let x_dpy = @XOpenDisplay[Pointer[_XDisplayHandle]](U32(0))
if x_dpy.is_null() then
  env.out.print(&quot;XOpenDisplay failed&quot;)
end

let e_dpy = @eglGetDisplay[Pointer[_EGLDisplayHandle]](x_dpy)
if e_dpy.is_null() then
  env.out.print(&quot;eglGetDisplay failed&quot;)
end
</code></pre>

<h1 id="ffi-functions-raising-errors">FFI functions raising errors</h1>
<p>FFI functions can raise Pony errors. Functions in existing C libraries are very unlikely to do this, but support libraries specifically written for use with Pony may well do.</p>
<p>FFI calls to functions that <strong>might</strong> raise an error <strong>must</strong> mark it as such by adding a ? after the arguments. For example:</p>
<pre><code class="pony">@os_send[U64](_event, data.cstring(), data.size()) ? // May raise an error
</code></pre>

<p>If a signature declaration is used then that must be marked as possibly raising an error in the same way. The FFI call site then does not have to mark it as well, although doing so is allowed.</p>
<pre><code class="pony">use @os_send[U64](ev: Event, buf: Pointer[U8] tag, len: U64) ?

@os_send(_event, data.cstring(), data.size()) // May raise an error
</code></pre>
          <aside class="copyright" role="note">
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../../compiler-clargs/clargs/" title="Compiler args">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Compiler args
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../linking-c/" title="Linking to C Libraries">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Linking to C Libraries
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = '';
    </script>
    <script src="../../assets/javascripts/application-997097ee0c.js"></script>
    
      <script src="../../js/highlight.pack.js"></script>
    
    
  </body>
</html>